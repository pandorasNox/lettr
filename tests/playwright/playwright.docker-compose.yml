services:
  playwright:
    image: mcr.microsoft.com/playwright:v1.54.1-noble
    volumes:
      - ./../../tests/playwright:/tests
      - playwright-node-modules:/tests/node_modules
      - caddy-data:/caddy-data:ro
    depends_on:
      - caddy
    networks:
      - shared-network
    environment:
      - CI=true
      - LETTR_APP_BASE_URL=https://lettrapp.aliases.containernetwork
    entrypoint: ["sh"]
    command:
      - "-c"
      - "cd /tests && npm ci && npx playwright test"
      # - "sleep $((60 * 60 * 24))"
    stop_grace_period: 1s
    #entrypoint: ["npm", "init", "&&", "npx", "playwright", "test"]
    # entrypoint: sh
    # command:
    #   - "-c"
    #   - "sleep $((60 * 60 * 24))"

  lettr-app:
    build: 
      context: ../../
      dockerfile: container-images/app/Dockerfile
    ports:
      - "8080:80"
    networks:
      - shared-network
    environment:
      - PORT=80
      - GITHUB_TOKEN=my-secret-token-for-local-dev
      - IMPRINT_URL=http://www.example.com/imprint
    stop_grace_period: 1s

  caddy:
    image: caddy:2
    container_name: caddy
    ports:
      - "443:443"
    volumes:
      - ./../../tests/playwright/Caddyfile:/etc/caddy/Caddyfile
      - caddy-data:/data
      - caddy-config:/config
    depends_on:
      - lettr-app
    networks:
      shared-network:
        aliases:
          - lettrapp.aliases.containernetwork
    stop_grace_period: 1s

volumes:
  playwright-node-modules:
  caddy-data:
  caddy-config:

networks:
  shared-network:
    driver: bridge